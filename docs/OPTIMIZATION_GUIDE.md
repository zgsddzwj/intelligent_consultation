# 系统优化与维护指南

本指南整合了项目的优化清单、已完成的改进总结及未来的优化建议，用于指导系统的持续迭代。

## 目录

1. [已完成的优化](#已完成的优化)
2. [优化清单 (Roadmap)](#优化清单-roadmap)
3. [详细优化建议](#详细优化建议)

---

## 已完成的优化

### 1. 知识图谱查询智能化
- **改进**: 从硬编码关键词匹配升级为 **基于 NER (实体识别)** 的智能查询。
- **效果**: 支持任意疾病、症状、药物的自然语言查询，不再受限于特定关键词。
- **模块**: `DoctorAgent` 集成了 `KnowledgeGraphRetriever` 的实体识别能力。

### 2. 流式接口集成 RAG
- **改进**: 流式接口 (`stream_chat`) 现已完整集成 RAG 检索和知识图谱查询。
- **效果**: 解决了流式响应内容空洞的问题，确保流式输出同样基于知识库，并能返回引用来源。

### 3. 对象存储架构升级
- **改进**: 从本地文件存储迁移至 **对象存储 (MinIO/S3)**。
- **效果**: 支持多实例无状态部署，解决了文件共享和持久化问题。实现文件上传、预签名下载及元数据管理。

### 4. 错误处理增强
- **改进**: 完善了 Neo4j/Milvus 连接失败时的日志记录和降级处理。

---

## 优化清单 (Roadmap)

按优先级排序的待办事项：

### 🔴 高优先级 (核心稳定性)

| 任务 | 说明 | 建议方案 |
|------|------|----------|
| **服务常驻** | Neo4j/Milvus/Redis 经常未启动导致功能降级 | 使用 K8s 或 Docker Compose 确保依赖服务高可用；完善健康检查脚本。 |
| **数据初始化** | 新环境部署后常忘记导入 KG 数据 | 在 CI/CD 或启动脚本中增加数据检查，若为空则自动提示或初始化。 |
| **向量删除** | `knowledge.py:240` 功能未实现 | 补全 Milvus 向量删除逻辑，确保知识库更新时无脏数据。 |

### 🟡 中优先级 (体验与质量)

| 任务 | 说明 | 建议方案 |
|------|------|----------|
| **多轮对话上下文** | 当前 RAG 主要针对单轮查询 | 引入会话历史管理 (Session Context)，让 Rerank 和 Rewriter 感知上下文。 |
| **无结果提示** | 检索失败时 LLM 容易幻觉 | 统一“无相关知识”时的 Fallback 话术，明确告知用户基于通用知识回答。 |
| **简化逻辑重构** | 代码中存在多处 `# TODO: simplified` | 完善 `doctor_agent.py` 中的药物名称提取；优化 `context_manager.py` 的 Token 计算。 |

### 🟢 低优先级 (工程与运维)

| 任务 | 说明 | 建议方案 |
|------|------|----------|
| **日志归档** | `app.log` 无轮转策略 | 配置 Loguru 的 `rotation` 和 `retention` 策略。 |
| **依赖清理** | `requirements.txt` 存在冗余 | 扫描并移除未使用的 Python 包。 |
| **测试覆盖** | 核心路径缺乏单测 | 补充 `test_rag.py` 和 `test_agent_flow.py`。 |

---

## 详细优化建议

### 1. 基础设施与依赖
- **问题**: 服务依赖未启动会导致系统静默降级，用户感知差。
- **建议**: 实现 **强依赖检查**，在后端启动时若关键服务 (Redis/PostgreSQL) 不可用直接报错退出；对于弱依赖 (Neo4j/Milvus) 提供明确的 Warning 日志和 Admin API 状态查询。

### 2. 智能问答与 RAG
- **实体识别**: 目前虽有 NER，但在复杂长句下效果仍有提升空间。建议引入少样本学习 (Few-shot) 或微调小模型。
- **Rerank 效率**: BGE-Reranker 推理较慢，可考虑增加 **语义缓存 (Semantic Cache)**，对高频相似 Query 直接返回缓存的排序结果。

### 3. 代码质量
- **模块化**: `services/` 目录略显拥挤，建议按领域拆分 (如 `services/consultation/`, `services/knowledge/`)。
- **类型安全**: 增加 MyPy 静态类型检查，减少运行时错误。
