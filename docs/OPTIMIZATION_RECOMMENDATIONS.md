# æ™ºèƒ½é—®ç­”ç³»ç»Ÿä¼˜åŒ–å»ºè®®

## ğŸ“Š å½“å‰çŠ¶æ€åˆ†æ

### âœ… å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½
1. **Agentç¼–æ’ç³»ç»Ÿ** - LangGraphå·¥ä½œæµå®Œæ•´å®ç°
2. **RAGæ£€ç´¢ç³»ç»Ÿ** - å¤šè·¯å¬å›ã€Rerankã€MLæ’åº
3. **çŸ¥è¯†å›¾è°±é›†æˆ** - Neo4jå®¢æˆ·ç«¯å’ŒæŸ¥è¯¢é€»è¾‘
4. **æµå¼å“åº”** - SSEæµå¼æ¥å£
5. **é£é™©è¯„ä¼°** - é«˜é£é™©å†…å®¹æ£€æµ‹

### âš ï¸ å‘ç°çš„é—®é¢˜

#### 1. **çŸ¥è¯†å›¾è°±æŸ¥è¯¢é€»è¾‘è¿‡äºç®€åŒ–** ğŸ”´ é«˜ä¼˜å…ˆçº§
**ä½ç½®**: `backend/app/agents/doctor_agent.py:93-104`

**é—®é¢˜**:
```python
# å½“å‰å®ç°ï¼šåªæ£€æŸ¥ç¡¬ç¼–ç å…³é”®è¯
if "é«˜è¡€å‹" in question or "è¡€å‹" in question:
    disease_info = self.kg_tool.execute("get_disease_info", disease_name="é«˜è¡€å‹")
```

**å½±å“**: 
- æ— æ³•å¤„ç†å…¶ä»–ç–¾ç—…æŸ¥è¯¢
- æ²¡æœ‰ä½¿ç”¨å®ä½“è¯†åˆ«å™¨
- çŸ¥è¯†å›¾è°±èƒ½åŠ›æœªå……åˆ†åˆ©ç”¨

**ä¼˜åŒ–æ–¹æ¡ˆ**:
- ä½¿ç”¨ `KnowledgeGraphRetriever` çš„å®ä½“è¯†åˆ«åŠŸèƒ½
- è‡ªåŠ¨æå–ç–¾ç—…ã€ç—‡çŠ¶ã€è¯ç‰©ç­‰å®ä½“
- æ”¯æŒé€šç”¨çŸ¥è¯†å›¾è°±æŸ¥è¯¢

#### 2. **æµå¼æ¥å£æœªé›†æˆRAGå’ŒçŸ¥è¯†å›¾è°±** ğŸ”´ é«˜ä¼˜å…ˆçº§
**ä½ç½®**: `backend/app/api/v1/consultation.py:196-212`

**é—®é¢˜**:
```python
# å½“å‰å®ç°ï¼šç›´æ¥è°ƒç”¨LLMï¼Œæ²¡æœ‰RAGæ£€ç´¢
prompt = f"ç”¨æˆ·é—®é¢˜ï¼š{sanitized_message}\n\nè¯·æä¾›ä¸“ä¸šã€å‡†ç¡®çš„å›ç­”ã€‚"
async for chunk in llm_service.stream_generate(...)
```

**å½±å“**:
- æµå¼å“åº”æ²¡æœ‰çŸ¥è¯†åº“æ”¯æŒ
- å›ç­”è´¨é‡ä¸å¦‚éæµå¼æ¥å£
- ç”¨æˆ·ä½“éªŒä¸ä¸€è‡´

**ä¼˜åŒ–æ–¹æ¡ˆ**:
- åœ¨æµå¼ç”Ÿæˆå‰æ‰§è¡ŒRAGæ£€ç´¢
- å°†æ£€ç´¢ç»“æœä½œä¸ºä¸Šä¸‹æ–‡
- æ”¯æŒæµå¼ç”Ÿæˆä¸­çš„çŸ¥è¯†å¼•ç”¨

#### 3. **æœåŠ¡ä¾èµ–æœªå¯åŠ¨** ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
**é—®é¢˜**:
- Neo4jæœªè¿è¡Œ â†’ çŸ¥è¯†å›¾è°±æ£€ç´¢è¿”å›ç©º
- Milvusæœªè¿è¡Œ â†’ å‘é‡æ£€ç´¢å¤±è´¥
- Redisæœªè¿è¡Œ â†’ ç¼“å­˜å’Œé™æµä¸å¯ç”¨

**å½±å“**:
- æ‰€æœ‰æ£€ç´¢æ–¹æ³•éƒ½å¤±è´¥
- ç³»ç»Ÿé™çº§åˆ°åŸºç¡€LLMå›ç­”
- å›ç­”è´¨é‡ä¸‹é™

**è§£å†³æ–¹æ¡ˆ**:
- å¯åŠ¨Neo4jæœåŠ¡
- å¯åŠ¨MilvusæœåŠ¡
- å¯åŠ¨RedisæœåŠ¡
- æˆ–å®Œå–„é™çº§ç­–ç•¥

#### 4. **å®ä½“è¯†åˆ«æœªå……åˆ†åˆ©ç”¨** ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
**ä½ç½®**: `backend/app/knowledge/rag/kg_retriever.py`

**é—®é¢˜**:
- æœ‰å®Œæ•´çš„å®ä½“è¯†åˆ«å™¨ (`MedicalEntityRecognizer`)
- ä½†åœ¨ `DoctorAgent` ä¸­æœªä½¿ç”¨
- çŸ¥è¯†å›¾è°±æŸ¥è¯¢ä¾èµ–ç¡¬ç¼–ç å…³é”®è¯

**ä¼˜åŒ–æ–¹æ¡ˆ**:
- åœ¨Agentä¸­é›†æˆå®ä½“è¯†åˆ«
- è‡ªåŠ¨æå–æŸ¥è¯¢ä¸­çš„åŒ»ç–—å®ä½“
- åŸºäºå®ä½“è¿›è¡ŒçŸ¥è¯†å›¾è°±æŸ¥è¯¢

#### 5. **é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥ä¸å®Œå–„** ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
**é—®é¢˜**:
- æœåŠ¡å¤±è´¥æ—¶é™é»˜è¿”å›ç©ºç»“æœ
- ç¼ºå°‘ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- é™çº§ç­–ç•¥ä¸å¤Ÿæ™ºèƒ½

**ä¼˜åŒ–æ–¹æ¡ˆ**:
- æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- å®ç°æ™ºèƒ½é™çº§ï¼ˆéƒ¨åˆ†æœåŠ¡å¤±è´¥æ—¶ä»å¯ä½¿ç”¨å…¶ä»–æœåŠ¡ï¼‰
- è¿”å›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯

#### 6. **ä¸Šä¸‹æ–‡ç®¡ç†ç¼ºå¤±** ğŸŸ¢ ä½ä¼˜å…ˆçº§
**é—®é¢˜**:
- æ²¡æœ‰å¯¹è¯å†å²ç®¡ç†
- å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ä¸¢å¤±
- æ— æ³•è¿›è¡Œä¸Šä¸‹æ–‡ç›¸å…³çš„æŸ¥è¯¢

**ä¼˜åŒ–æ–¹æ¡ˆ**:
- å®ç°å¯¹è¯å†å²å­˜å‚¨
- åœ¨æŸ¥è¯¢æ—¶åŒ…å«å†å²ä¸Šä¸‹æ–‡
- æ”¯æŒä¸Šä¸‹æ–‡ç›¸å…³çš„å®ä½“è¯†åˆ«

## ğŸš€ ä¼˜åŒ–å®æ–½è®¡åˆ’

### é˜¶æ®µ1: æ ¸å¿ƒåŠŸèƒ½ä¼˜åŒ–ï¼ˆç«‹å³å®æ–½ï¼‰

#### 1.1 ä¼˜åŒ–çŸ¥è¯†å›¾è°±æŸ¥è¯¢é€»è¾‘
**æ–‡ä»¶**: `backend/app/agents/doctor_agent.py`

```python
def execute_kg():
    """æ‰§è¡ŒçŸ¥è¯†å›¾è°±æŸ¥è¯¢ï¼ˆä½¿ç”¨å®ä½“è¯†åˆ«ï¼‰"""
    try:
        # ä½¿ç”¨çŸ¥è¯†å›¾è°±æ£€ç´¢å™¨ï¼ˆå·²åŒ…å«å®ä½“è¯†åˆ«ï¼‰
        from app.knowledge.rag.kg_retriever import KnowledgeGraphRetriever
        kg_retriever = KnowledgeGraphRetriever()
        
        # è‡ªåŠ¨æå–å®ä½“å¹¶æŸ¥è¯¢
        kg_results = kg_retriever.retrieve(question, top_k=3)
        
        if kg_results:
            # æ ¼å¼åŒ–çŸ¥è¯†å›¾è°±ç»“æœ
            kg_context = "\n".join([
                f"- {r.get('text', '')}" 
                for r in kg_results[:3]
            ])
            return ("kg", kg_results, kg_context)
        return ("kg", None, "")
    except Exception as e:
        app_logger.warning(f"çŸ¥è¯†å›¾è°±æŸ¥è¯¢å¤±è´¥: {e}")
        return ("kg", None, "")
```

#### 1.2 é›†æˆRAGåˆ°æµå¼æ¥å£
**æ–‡ä»¶**: `backend/app/api/v1/consultation.py`

```python
# åœ¨æµå¼ç”Ÿæˆå‰æ‰§è¡ŒRAGæ£€ç´¢
from app.agents.orchestrator import AgentOrchestrator

# ä½¿ç”¨ç¼–æ’å™¨è·å–ä¸Šä¸‹æ–‡
orchestrator = AgentOrchestrator()
result = orchestrator.process(
    user_input=sanitized_message,
    context=request.context or {}
)

# è·å–æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡
rag_context = result.get("context_used", "")
kg_context = result.get("kg_context", "")

# æ„å»ºåŒ…å«ä¸Šä¸‹æ–‡çš„prompt
full_context = f"{rag_context}\n\n{kg_context}".strip()
prompt = f"åŸºäºä»¥ä¸‹åŒ»ç–—çŸ¥è¯†ï¼š\n{full_context}\n\nç”¨æˆ·é—®é¢˜ï¼š{sanitized_message}\n\nè¯·æä¾›ä¸“ä¸šã€å‡†ç¡®çš„å›ç­”ã€‚"
```

### é˜¶æ®µ2: æœåŠ¡ä¾èµ–å®Œå–„ï¼ˆçŸ­æœŸï¼‰

#### 2.1 å¯åŠ¨å¿…éœ€æœåŠ¡
```bash
# å¯åŠ¨Neo4j
docker run -d --name neo4j \
  -p 7474:7474 -p 7687:7687 \
  -e NEO4J_AUTH=neo4j/medical123 \
  neo4j:latest

# å¯åŠ¨Milvus
docker run -d --name milvus \
  -p 19530:19530 \
  milvusdb/milvus:latest

# å¯åŠ¨Redisï¼ˆå¦‚æœæœªè¿è¡Œï¼‰
redis-server
```

#### 2.2 å®Œå–„é™çº§ç­–ç•¥
- éƒ¨åˆ†æœåŠ¡å¤±è´¥æ—¶ï¼Œä½¿ç”¨å¯ç”¨æœåŠ¡
- æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º
- è®°å½•æœåŠ¡çŠ¶æ€

### é˜¶æ®µ3: é«˜çº§åŠŸèƒ½ï¼ˆä¸­æœŸï¼‰

#### 3.1 å¯¹è¯å†å²ç®¡ç†
- å®ç°å¯¹è¯ä¸Šä¸‹æ–‡å­˜å‚¨
- æ”¯æŒå¤šè½®å¯¹è¯
- ä¸Šä¸‹æ–‡ç›¸å…³çš„å®ä½“è¯†åˆ«

#### 3.2 æ™ºèƒ½å®ä½“è¯†åˆ«
- åœ¨Agentå±‚é¢é›†æˆå®ä½“è¯†åˆ«
- è‡ªåŠ¨æå–åŒ»ç–—å®ä½“
- åŸºäºå®ä½“ä¼˜åŒ–æŸ¥è¯¢ç­–ç•¥

#### 3.3 å›ç­”è´¨é‡ä¼˜åŒ–
- æ·»åŠ æ¥æºå¼•ç”¨
- å®ç°å›ç­”éªŒè¯
- æ”¯æŒå¤šç­”æ¡ˆèåˆ

## ğŸ“ å…·ä½“ä»£ç ä¿®æ”¹å»ºè®®

### ä¿®æ”¹1: ä¼˜åŒ–DoctorAgentçš„çŸ¥è¯†å›¾è°±æŸ¥è¯¢

**æ–‡ä»¶**: `backend/app/agents/doctor_agent.py`

**ä¿®æ”¹ä½ç½®**: `_handle_general_consultation` æ–¹æ³•ä¸­çš„ `execute_kg` å‡½æ•°

**ä¿®æ”¹å†…å®¹**:
```python
def execute_kg():
    """æ‰§è¡ŒçŸ¥è¯†å›¾è°±æŸ¥è¯¢ï¼ˆä½¿ç”¨å®ä½“è¯†åˆ«ï¼‰"""
    try:
        # ç›´æ¥ä½¿ç”¨RAGå·¥å…·ä¸­çš„çŸ¥è¯†å›¾è°±æ£€ç´¢å™¨
        # RAGToolå·²ç»é›†æˆäº†AdvancedRAGï¼Œå…¶ä¸­åŒ…å«çŸ¥è¯†å›¾è°±æ£€ç´¢
        rag_result = self.rag_tool.execute(question, top_k=5)
        
        # ä»RAGç»“æœä¸­æå–çŸ¥è¯†å›¾è°±ç›¸å…³çš„ç»“æœ
        kg_results = [
            r for r in rag_result.get("results", [])
            if r.get("retrieval_method") == "knowledge_graph"
        ]
        
        if kg_results:
            kg_context = "\n".join([
                f"- {r.get('text', '')}" 
                for r in kg_results[:3]
            ])
            return ("kg", kg_results, kg_context)
        return ("kg", None, "")
    except Exception as e:
        app_logger.warning(f"çŸ¥è¯†å›¾è°±æŸ¥è¯¢å¤±è´¥: {e}")
        return ("kg", None, "")
```

### ä¿®æ”¹2: æµå¼æ¥å£é›†æˆAgent

**æ–‡ä»¶**: `backend/app/api/v1/consultation.py`

**ä¿®æ”¹ä½ç½®**: `chat_stream` å‡½æ•°ä¸­çš„æµå¼ç”Ÿæˆéƒ¨åˆ†

**ä¿®æ”¹å†…å®¹**:
```python
# å‘é€å¼€å§‹ä¿¡å·
yield f"data: {json.dumps({'type': 'start', 'consultation_id': consultation_id})}\n\n"

# ä½¿ç”¨ç¼–æ’å™¨è·å–ä¸Šä¸‹æ–‡ï¼ˆåŒæ­¥æ‰§è¡Œï¼Œå¿«é€Ÿå®Œæˆï¼‰
try:
    result = orchestrator.process(
        user_input=sanitized_message,
        context=request.context or {}
    )
    
    # è·å–æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡
    rag_context = result.get("context_used", "")
    sources = result.get("sources", [])
    
    # å‘é€æ£€ç´¢å®Œæˆä¿¡å·
    if sources:
        yield f"data: {json.dumps({'type': 'sources', 'sources': sources})}\n\n"
    
    # æ„å»ºåŒ…å«ä¸Šä¸‹æ–‡çš„prompt
    if rag_context:
        prompt = f"åŸºäºä»¥ä¸‹åŒ»ç–—çŸ¥è¯†ï¼š\n{rag_context}\n\nç”¨æˆ·é—®é¢˜ï¼š{sanitized_message}\n\nè¯·æä¾›ä¸“ä¸šã€å‡†ç¡®çš„å›ç­”ã€‚"
    else:
        prompt = f"ç”¨æˆ·é—®é¢˜ï¼š{sanitized_message}\n\nè¯·æä¾›ä¸“ä¸šã€å‡†ç¡®çš„å›ç­”ã€‚"
        
except Exception as e:
    app_logger.warning(f"è·å–ä¸Šä¸‹æ–‡å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€prompt: {e}")
    prompt = f"ç”¨æˆ·é—®é¢˜ï¼š{sanitized_message}\n\nè¯·æä¾›ä¸“ä¸šã€å‡†ç¡®çš„å›ç­”ã€‚"
```

## ğŸ¯ ä¼˜å…ˆçº§æ€»ç»“

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰
1. âœ… ä¼˜åŒ–çŸ¥è¯†å›¾è°±æŸ¥è¯¢é€»è¾‘ - ä½¿ç”¨å®ä½“è¯†åˆ«
2. âœ… æµå¼æ¥å£é›†æˆRAGå’ŒçŸ¥è¯†å›¾è°±

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆ1-2å‘¨å†…ï¼‰
3. å¯åŠ¨å¿…éœ€æœåŠ¡ï¼ˆNeo4jã€Milvusã€Redisï¼‰
4. å®Œå–„é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥
5. å……åˆ†åˆ©ç”¨å®ä½“è¯†åˆ«åŠŸèƒ½

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰
6. å¯¹è¯å†å²ç®¡ç†
7. å›ç­”è´¨é‡ä¼˜åŒ–
8. æ€§èƒ½ä¼˜åŒ–

## ğŸ“Š é¢„æœŸæ•ˆæœ

å®æ–½è¿™äº›ä¼˜åŒ–åï¼Œé¢„æœŸè¾¾åˆ°ï¼š

1. **çŸ¥è¯†å›¾è°±åˆ©ç”¨ç‡æå‡** - ä»ç¡¬ç¼–ç æŸ¥è¯¢åˆ°è‡ªåŠ¨å®ä½“è¯†åˆ«
2. **å›ç­”è´¨é‡æå‡** - æµå¼å’Œéæµå¼æ¥å£éƒ½ä½¿ç”¨RAG
3. **ç³»ç»Ÿç¨³å®šæ€§æå‡** - æ›´å¥½çš„é™çº§ç­–ç•¥å’Œé”™è¯¯å¤„ç†
4. **ç”¨æˆ·ä½“éªŒæå‡** - æ›´å‡†ç¡®çš„å›ç­”å’Œæ›´å¥½çš„äº¤äº’

## ğŸ” æµ‹è¯•å»ºè®®

ä¼˜åŒ–åéœ€è¦æµ‹è¯•ï¼š

1. **çŸ¥è¯†å›¾è°±æŸ¥è¯¢æµ‹è¯•**
   - æµ‹è¯•ä¸åŒç–¾ç—…çš„æŸ¥è¯¢
   - æµ‹è¯•ç—‡çŠ¶æŸ¥è¯¢
   - æµ‹è¯•è¯ç‰©æŸ¥è¯¢

2. **æµå¼æ¥å£æµ‹è¯•**
   - éªŒè¯RAGæ£€ç´¢æ˜¯å¦æ‰§è¡Œ
   - éªŒè¯ä¸Šä¸‹æ–‡æ˜¯å¦æ­£ç¡®ä¼ é€’
   - éªŒè¯å›ç­”è´¨é‡

3. **é™çº§ç­–ç•¥æµ‹è¯•**
   - æµ‹è¯•æœåŠ¡å¤±è´¥æ—¶çš„è¡Œä¸º
   - éªŒè¯éƒ¨åˆ†æœåŠ¡å¯ç”¨æ—¶çš„è¡¨ç°
   - éªŒè¯é”™è¯¯æç¤ºæ˜¯å¦å‹å¥½
